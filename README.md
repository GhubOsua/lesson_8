# Урок 8. Написать скрипт на языке bash.
В репозитори находятся файлы: [Сам скрипт](les8.sh), [лог файла](access-4560-644067.log), [файл строки](str_file), [msg](msg).
## Описание решения задания:
```
написать скрипт для крона
который раз в час присылает на заданную почту
- X IP адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта
- Y запрашиваемых адресов (с наибольшим кол-вом запросов) с указанием кол-ва запросов c момента последнего запуска скрипта
- все ошибки c момента последнего запуска
- список всех кодов возврата с указанием их кол-ва с момента последнего запуска
в письме должно быть прописан обрабатываемый временной диапазон
должна быть реализована защита от мультизапуска
```
### 1. Устанавливаем yum install mailx && yum install postfix, для отправки почты;
### 2. Правим vim /etc/postfix/main.cf. Выключаем SELinux;
```
Пришлось закомментировать #inet_protocols = all;
setenforce 0
```
### 3. Создаем скрипт:
#### 3.1. Создаем файл, в котором будет содержаться количество строк, это переменная file=/opt/str_file;
#### 3.2. Далее создал функцию myfunc, которая выводит командой echo переменные x_ip y_adr z_err w_code time_1 time_2. В переменных содержится вывод скрипта для задания;
#### 3.3. После объявляется вторая функция myfunc2, в ней генерируются переменные для myfunc на основе пост усливия if then else fi. Если существует файл str_file и его размер 0, тогда мы обрабатываем [лог файла](access-4560-644067.log) с 1 строки по последней. В конце условия мы запоминаем количество строк и записываем в [файл строки](str_file), чтобы начать следующий раз с последней обрабатываемой строки.
#### 3.4. На пред. последних шагах мы используем командут mail для отправки вывода скрипта на почту root. Использовал -S sendwait, для того чтобы юнит service не сразу закрывал процесс отправки, иначе не выполянется инстукция отправки;
#### 3.5. В конце мы исполюзуем trap, пока выполняется юнит service, не запустится второй раз скрипт [сам скрипт](les8.sh);
### 4. Создание юнитов systemd .service и .timer:

```
[root@lesson8 vagrant]# cat  /etc/systemd/system/les8.service 
[Unit]
Description=Run script and sending mail

[Service]
Type=oneshot
ExecStart=/opt/les8.sh

```
```
[root@lesson8 vagrant]# cat  /etc/systemd/system/les8.timer 
[Unit]
Description=Run script les8.sh every 15 second

[Timer]
#Run every 15 second
OnUnitActiveSec=15
Unit=les8.service

[Install]
WantedBy=timers.target

```
### 5. Перечитываем конфигурацию systemd командой: systemctl daemon-reload. Сначала запускаем юнит timer, после юнит service: systemctl start  les8.timer && systemctl start les8.service;
### 6. Смотрим письмо [msg](msg) в /var/spool/mail/root. Проверяем на ошибки journalctl -xe либо по нашему юниту journalctl -u les8.service;

